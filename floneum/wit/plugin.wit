package plugins:main;

interface imports {

  store: func(key: list<u8>, value: list<u8>);

  load: func(key: list<u8>) -> list<u8>;

  unload: func(key: list<u8>);

  log-to-user: func(information: string);
}

interface types {
  record header {
    key: string,
    value: string,
  }

  get-request: func(url: string, headers: list<header>) -> string;

  enum browser-mode {
    headless,
    headfull,
  }

  record page {
    id: u64,
    owned: bool,
  }
  create-page: func(mode: browser-mode, url: string) -> page;
  find-in-current-page: func(page: page, selector: string) -> node;
  screenshot-browser: func(page: page) -> list<u8>;
  page-html: func(page: page) -> string;
  
  record node {
    id: u64,
    owned: bool,
  }
  drop-node: func(node: node);
  get-element-text: func(node: node) -> string;
  click-element: func(node: node);
  type-into-element: func(node: node, keys: string);
  get-element-outer-html: func(node: node) -> string;
  screenshot-element: func(node: node) -> list<u8>;
  find-child-of-element: func(node: node, selector: string) -> node;

  record embedding-db {
    id: u64,
    owned: bool,
  }
  create-embedding-db: func(embeddings: list<embedding>, documents: list<string>) -> embedding-db;
  drop-embedding-db: func(model: embedding-db);
  add-embedding: func(db: embedding-db, embedding: embedding, documents: string);
  find-closest-documents: func(db: embedding-db, search: embedding, count: u32) -> list<string>;

  record text-generation-model {
    id: u64,
    owned: bool,
  }
  create-model: func(ty: model-type) -> text-generation-model;
  drop-model: func(model: text-generation-model);
  text-generation-model-downloaded: func(ty: model-type) -> bool;
  infer: func(model: text-generation-model, input: string, max-tokens: option<u32>, stop-on: option<string>) -> string;
  infer-structured: func(model: text-generation-model, input: string, regex: string) -> string;

  record embedding-model {
    id: u64,
    owned: bool,
  }
  create-embedding-model: func(ty: embedding-model-type) -> embedding-model;
  drop-embedding-model: func(model: embedding-model);
  embedding-model-downloaded: func(ty: embedding-model-type) -> bool;
  get-embedding: func(model: embedding-model, document: string) -> embedding;

  record embedding {
    vector: list<float32>
  }

  variant primitive-value {
    model(text-generation-model),
    embedding-model(embedding-model),
    model-type(model-type),
    embedding-model-type(embedding-model-type),
    database(embedding-db),
    number(s64),
    text(string),
    file(string),
    folder(string),
    embedding(embedding),
    boolean(bool),
    page(page),
    node(node)
  }
  
  variant value-type {
    single(primitive-value-type),
    many(primitive-value-type),
  }

  enum primitive-value-type {
    number,
    text,
    file,
    folder,
    embedding,
    database,
    model,
    embedding-model,
    model-type,
    embedding-model-type,
    boolean,
    page,
    node,
    any
  }

  record definition {
    name: string,
    description: string,
    inputs: list<io-definition>,
    outputs: list<io-definition>,
    examples: list<example>
  }

  record example {
    name: string,
    inputs: list<list<primitive-value>>,
    outputs: list<list<primitive-value>>,
  }

  record io-definition {
    name: string,
    ty: value-type,
  }

  variant model-type {
    mistral-seven,
    mistral-seven-instruct,
    mistral-seven-instruct-two,
    zephyr-seven-alpha,
    zephyr-seven-beta,
    open-chat-seven,
    starling-seven-alpha,
    tiny-llama-chat,
    tiny-llama,
    llama-seven,
    llama-thirteen,
    llama-seventy,
    llama-seven-chat,
    llama-thirteen-chat,
    llama-seventy-chat,
    llama-seven-code,
    llama-thirteen-code,
    llama-thirty-four-code,
    solar-ten,
    solar-ten-instruct,
    phi-one,
    phi-one-point-five,
    phi-two,
    puffin-phi-two,
    dolphin-phi-two
  }
  variant embedding-model-type { bert }
}

interface definitions {
  use types.{definition, primitive-value};

  structure: func() -> definition;

  run: func(inputs: list<list<primitive-value>>) -> list<list<primitive-value>>;
}

world exports {
  import imports;
  import types;
}

world plugin-world {
  export definitions;
  import imports;
  import types;
}

world both {
  import imports;
  export definitions;
}
